<!DOCTYPE html>
<html lang="en">
  <meta charset="utf-8" />
  <style>
    .link {
      /* stroke: #aaa; */
      stroke: #ccc;
      /* stroke-width: 1.5px; */
    }

    .node {
      pointer-events: all;
      stroke: none;
      stroke-width: 40px;
      font: 10px sans-serif;
    }
  </style>
  <head>
    <!-- Latest compiled CSS v3.4.1 -->
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
    />
    <!-- jQuery library v3.5.1-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Latest compiled JavaScript v3.4.1 -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <!-- Latest compiled d3 v3 -->
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  </head>
  <body>
    <div style="padding-top: 10px; padding-left: 10px">
      <form id="nodeGraphForm" class="form">
        <label for="selectLeague">Select a League:</label>
        <br />
        <select
          id="selectLeague"
          name="Select a League"
          onchange="loadLeagueYears(this)"
        ></select>
        <br />
        <label for="selectYear">Select a Year:</label>
        <br />
        <select
          id="selectYear"
          name="Select a Year"
          onchange="loadTeams(this)"
        ></select>
        <br />
        <label for="selectTeamOne">Select Team 1:</label>
        <br />
        <select id="selectTeamOne" name="Select Team 1"></select>
        <br />
        <label for="selectTeamTwo">Select Team 2:</label>
        <br />
        <select id="selectTeamTwo" name="Select Team 2"></select>
        <br />
        <div style="padding-top: 10px; padding-left: 50px">
          <button type="button" onclick="getNodeData()">Submit</button>
        </div>
        <br />
        Note: Select League then Year
      </form>
    </div>
    <div>
      <script>
        //declare global vars
        let matchesJson;
        let teamCsv;
        let leaguesCsv;
        let league_array = [];
        let league_id;

        function getBaseData() {
          //reading the data

          var PromiseWrapper = (xhr, d) =>
            new Promise((resolve) => xhr(d, (p) => resolve(p)));

          Promise.all([
            PromiseWrapper(d3.json, "data/match.json"),
            PromiseWrapper(d3.csv, "data/team.csv"),
            PromiseWrapper(d3.csv, "data/league.csv"),
          ]).then((resolve) => {
            matchesJson = resolve[0];
            teamCsv = resolve[1];
            leaguesCsv = resolve[2];
            let matchesJson_new = [];
            matchesJson.forEach(function (data) {
              let home_t;
              let away_t;
              teamCsv.forEach(function (team_data) {
                if (team_data.team_api_id == data.home_team_api_id) {
                  home_t = team_data.team_long_name;
                } else if (team_data.team_api_id == data.away_team_api_id) {
                  away_t = team_data.team_long_name;
                }
              });
              let temp_data = data;
              temp_data["home_team_name"] = home_t;
              temp_data["away_team_name"] = away_t;
              temp_data["match_name"] = home_t + away_t;
              matchesJson_new.push(temp_data);
            });
            leaguesCsv.forEach(function (data) {
              league_array.push(data.name);
            });

            matchesJson = matchesJson_new;
            makeForm();
          });
        }

        function makeForm() {
          var select = document.getElementById("selectLeague");
          var options = league_array;
          var el = document.createElement("option");
          el.textContent = "";
          el.value = "";
          select.appendChild(el);
          for (var i = 0; i < options.length; i++) {
            var opt = options[i];
            var el = document.createElement("option");
            el.textContent = opt;
            el.value = opt;
            select.appendChild(el);
          }
        }

        function loadLeagueYears(input) {
          var btnValue = input.options[input.selectedIndex].value;
          let year_array = [];
          leaguesCsv.forEach(function (data) {
            if (data.name === btnValue) {
              league_id = data.id;
            }
          });

          matchesJson.forEach(function (data) {
            if (data.league_id.toString() === league_id.toString()) {
              if (year_array.includes(data.season) === false) {
                year_array.push(data.season);
              }
            }
          });

          var select = document.getElementById("selectYear");
          while (select.options.length > 0) {
            select.remove(0);
          }
          var options = year_array;
          var el = document.createElement("option");
          el.textContent = "";
          el.value = "";
          select.appendChild(el);
          for (var i = 0; i < options.length; i++) {
            var opt = options[i];
            var el = document.createElement("option");
            el.textContent = opt;
            el.value = opt;
            select.appendChild(el);
          }
        }

        function loadTeams(input) {
          var btnValue = input.options[input.selectedIndex].value;
          let team_array = [];
          matchesJson.forEach(function (data) {
            if (
              data.season.toString() === btnValue.toString() &&
              data.league_id.toString() === league_id.toString()
            ) {
              if (team_array.includes(data.home_team_name) === false) {
                team_array.push(data.home_team_name);
              }
              if (team_array.includes(data.away_team_name) === false) {
                team_array.push(data.away_team_name);
              }
            }
          });

          team_array.sort();

          var select = document.getElementById("selectTeamOne");
          while (select.options.length > 0) {
            select.remove(0);
          }
          var options = team_array;
          var el = document.createElement("option");
          el.textContent = "";
          el.value = "";
          select.appendChild(el);
          for (var i = 0; i < options.length; i++) {
            var opt = options[i];
            var el = document.createElement("option");
            el.textContent = opt;
            el.value = opt;
            select.appendChild(el);
          }

          var select = document.getElementById("selectTeamTwo");
          while (select.options.length > 0) {
            select.remove(0);
          }
          var options = team_array;
          var el = document.createElement("option");
          el.textContent = "";
          el.value = "";
          select.appendChild(el);
          for (var i = 0; i < options.length; i++) {
            var opt = options[i];
            var el = document.createElement("option");
            el.textContent = opt;
            el.value = opt;
            select.appendChild(el);
          }
        }

        function getNodeData() {
          let leagueElement = document.getElementById("selectLeague");
          let leagueValue =
            leagueElement.options[leagueElement.selectedIndex].value;
          let yearValue;
          let yearElement;
          let teamOneValue;
          let teamOneElement;
          let teamTwoValue;
          let teamTwoElement;
          try {
            yearElement = document.getElementById("selectYear");
            yearValue = yearElement.options[yearElement.selectedIndex].value;
            teamOneElement = document.getElementById("selectTeamOne");
            teamOneValue =
              teamOneElement.options[teamOneElement.selectedIndex].value;
            teamTwoElement = document.getElementById("selectTeamTwo");
            teamTwoValue =
              teamTwoElement.options[teamTwoElement.selectedIndex].value;
          } catch (err) {
            alert("Please select BOTH a year and a league");
            return;
          }

          if (leagueValue === "" || yearValue === "") {
            alert("Please select BOTH a year and a league");
            return;
          } else if (teamOneValue === "" || teamTwoValue === "") {
            alert("Please select TWO teams");
            return;
          } else if (teamOneValue === teamTwoValue) {
            alert("Please ensure teams selected are DIFFERENT teams");
          } else {
            let filtered_data = [];
            let highest_stage; //q to self: how to handle when they play more than once in a season for other visual to pick up?
            matchesJson.forEach(function (data) {
              if (
                data.league_id.toString() === league_id.toString() &&
                data.season.toString() === yearValue.toString() &&
                (data.away_team_name.toString() === teamOneValue.toString() ||
                  data.away_team_name.toString() === teamTwoValue.toString() ||
                  data.home_team_name.toString() === teamOneValue.toString() ||
                  data.home_team_name.toString() === teamTwoValue.toString())
              ) {
                if (highest_stage === undefined) {
                  highest_stage = data.stage;
                } else if (highest_stage < data.stage) {
                  highest_stage = data.stage;
                }
                filtered_data.push(data);
              }
            });
            filtered_data.sort((a, b) =>
              a.stage > b.stage
                ? 1
                : a.stage === b.stage
                ? a.stage > b.size
                  ? 1
                  : -1
                : -1
            );
            let temp_obj = { nodes: [], links: [] };
            for (var y = 0; y < filtered_data.length; y++) {
              let destinations = 0;
              temp_obj.nodes.push({ name: filtered_data[y].match_name });
              let indexer = y + 1;
              while (indexer < filtered_data.length) {
                if (destinations === 2 || y + 1 === highest_stage) {
                  break;
                } else {
                  if (
                    filtered_data[y].home_team_api_id.toString() ===
                      filtered_data[indexer].home_team_api_id.toString() ||
                    filtered_data[y].home_team_api_id.toString() ===
                      filtered_data[indexer].away_team_api_id.toString() ||
                    filtered_data[y].away_team_api_id.toString() ===
                      filtered_data[indexer].home_team_api_id.toString() ||
                    filtered_data[y].away_team_api_id.toString() ===
                      filtered_data[indexer].away_team_api_id.toString()
                  ) {
                    temp_obj.links.push({ source: y, target: indexer });
                    destinations++;
                  }
                  indexer++;
                }
              }
            }
            makeNodegraph(temp_obj);
          }
        }

        function makeNodegraph(node_data) {
          var width = 1700,
            height = 1000;

          d3.select("#nodeGraph").remove();

          var svg = d3
            .select("body")
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .attr("id", "nodeGraph");

          var json = node_data;

          var force = d3.layout
            .force()
            .gravity(0.05)
            .distance(100)
            .charge(-100)
            .size([width, height])
            .nodes(json.nodes)
            .links(json.links)
            .start();

          var link = svg
            .selectAll(".link")
            .data(json.links)
            .enter()
            .append("line")
            .attr("class", "link");

          var node = svg
            .selectAll(".node")
            .data(json.nodes)
            .enter()
            .append("g")
            .attr("class", "node")
            .call(force.drag);

          node
            .append("image")
            .attr("xlink:href", function (d) {
              return "match_banners/" + d.name + ".png";
            })
            .attr("x", -8)
            .attr("y", -8)
            .attr("width", 16)
            .attr("height", 16);

          node
            .append("text")
            .attr("dx", 12)
            .attr("dy", ".35em")
            .text(function (d) {
              return d.name;
            });

          force.on("tick", function () {
            link
              .attr("x1", function (d) {
                return d.source.x;
              })
              .attr("y1", function (d) {
                return d.source.y;
              })
              .attr("x2", function (d) {
                return d.target.x;
              })
              .attr("y2", function (d) {
                return d.target.y;
              });

            node.attr("transform", function (d) {
              return "translate(" + d.x + "," + d.y + ")";
            });
          });
        }

        function main() {
          getBaseData();
        }

        main();
      </script>
    </div>
  </body>
</html>
